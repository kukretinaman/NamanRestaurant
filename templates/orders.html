{% extends 'base.html' %}
{% block title %}My Orders{% endblock %}

{% block extra_css %}
<style>
  .order-card {
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
  }
  .order-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
  }
  .badge-status-pending {
    background: linear-gradient(45deg, #ffc107, #ff8c00);
    color: #212529;
    font-weight: 600;
  }
  .badge.bg-success {
    background: linear-gradient(45deg, #198754, #20c997) !important;
    font-weight: 600;
  }
  .badge.bg-secondary {
    background: linear-gradient(45deg, #6c757d, #495057) !important;
    font-weight: 600;
  }
  .review-form-card {
    border-left: 4px solid #0d6efd;
  }
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
  <h2 class="fw-bold">Your Orders</h2>
  <!-- üîç Search Form -->
  <form method="get" class="mb-3">
    <div class="input-group">
      <input type="text" class="form-control" name="search" placeholder="Search by order ID, restaurant, or item"
             value="{{ search }}">
      <button class="btn btn-primary" type="submit">Search</button>
    </div>
  </form>
  <p class="small-muted">Track your orders and view details.</p>
</div>

{% if orders %}
  <div class="row g-3">
    {% for order in orders %}
    <div class="col-12 col-md-6">
      <div class="card shadow-sm card-hover">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h5 class="fw-bold mb-1">Order #{{ order.id }}</h5>
              <div class="small-muted">{{ order.created_at|date:"F j, Y H:i" }}</div>
            </div>
            <div class="text-end">
              {% if order.status == 'Pending' %}
                <span class="badge badge-status-pending fs-6">Pending</span>
              {% elif order.status == 'Completed' %}
                <span class="badge bg-success fs-6">Completed</span>
              {% else %}
                <span class="badge bg-secondary fs-6">{{ order.status }}</span>
              {% endif %}
            </div>
          </div>
          
          {% if order.status == 'Completed' %}
          <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#reviewForm{{ order.id }}" aria-expanded="false">
              <i class="bi bi-star me-1"></i>Add Review
            </button>
          </div>
          {% endif %}

          <hr class="my-2">

          <ul class="list-group list-group-flush mb-2">
            {% for item in order.orderitem_set.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center gap-2">
                {% if item.food_item.image %}
                  <img src="{{ item.food_item.image.url }}" width="50" style="object-fit:cover" class="rounded">
                {% endif %}
                <div>
                  <div class="fw-semibold">{{ item.food_item.name }}</div>
                  <small class="text-muted">x{{ item.quantity }}</small>
                </div>
              </div>
              <div class="fw-bold text-success">‚Çπ{{ item.food_item.price|floatformat:2 }}</div>
            </li>
            {% endfor %}
          </ul>

          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-bold">Total: ‚Çπ{{ order.total_price|floatformat:2 }}</div>
            {% if order.status == 'Pending' %}
            <form method="post" action="{% url 'cancel_order' order.id %}" class="d-inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Cancel</button>
            </form>
            {% endif %}
          </div>

          <!-- Review Form (Collapsible) -->
          {% if order.status == 'Completed' %}
          <div class="collapse mt-3" id="reviewForm{{ order.id }}">
            <div class="card border-primary">
              <div class="card-header bg-light">
                <h6 class="fw-bold mb-0 text-primary">
                  <i class="bi bi-star-fill me-1"></i>Write a Review
                </h6>
              </div>
              <div class="card-body">
                <form method="post" action="{% url 'add_review' order.restaurant.id %}">
                  {% csrf_token %}
                  <input type="hidden" name="order_id" value="{{ order.id }}">
                  
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Rating</label>
                    <select name="rating" class="form-select" required>
                      <option value="">Select rating</option>
                      <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 Stars - Excellent</option>
                      <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4 Stars - Very Good</option>
                      <option value="3">‚≠ê‚≠ê‚≠ê 3 Stars - Good</option>
                      <option value="2">‚≠ê‚≠ê 2 Stars - Fair</option>
                      <option value="1">‚≠ê 1 Star - Poor</option>
                    </select>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Comment</label>
                    <textarea name="comment" class="form-control" rows="3" placeholder="Share your experience with this order..." required></textarea>
                  </div>
                  
                  <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#reviewForm{{ order.id }}">Cancel</button>
                    <button type="submit" class="btn btn-success btn-sm">
                      <i class="bi bi-check-circle me-1"></i>Submit Review
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if orders.has_other_pages %}
  <div class="d-flex justify-content-center mt-4">
    <nav aria-label="Orders pagination">
      <ul class="pagination">
        {% if orders.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ orders.previous_page_number }}{% if search %}&search={{ search }}{% endif %}">Previous</a>
          </li>
        {% endif %}
        
        <li class="page-item active">
          <span class="page-link">Page {{ orders.number }} of {{ orders.paginator.num_pages }}</span>
        </li>
        
        {% if orders.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ orders.next_page_number }}{% if search %}&search={{ search }}{% endif %}">Next</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% endif %}

{% else %}
  <div class="text-center py-5">
    <i class="bi bi-bag-x fs-1 text-muted"></i>
    <h3 class="mt-3">No Orders Found</h3>
    <p class="text-muted">
      {% if search %}
        No orders match your search criteria.
      {% else %}
        You haven't placed any orders yet.
      {% endif %}
    </p>
    <a href="{% url 'restaurant_list' %}" class="btn btn-primary">Browse Restaurants</a>
  </div>
{% endif %}
{% endblock %}