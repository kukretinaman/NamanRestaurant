{% extends "base.html" %}
{% load static %}

{% block title %}Restaurants{% endblock %}

{% block extra_css %}
<style>
  .restaurant-img {
    height: 220px;
    width: 100%;
    object-fit: contain; /* show full photo without cropping */
    background: #0b0e13; /* letterbox background */
    border-top-left-radius: .375rem;
    border-top-right-radius: .375rem;
  }
  .img-wrap { position: relative; }
  .img-wrap .overlay { position:absolute; left:0; right:0; bottom:0; top:auto; background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.75)); color:#fff; opacity:0; transition: opacity .2s ease; }
  .img-wrap:hover .overlay { opacity:1; }
  .img-wrap .overlay .overlay-text { padding: .5rem .75rem; font-size:.95rem; }
  /* Compact recommendations */
  .reco .restaurant-img { height: 140px; }
  .reco .card-body { padding: .75rem; }
  .reco .btn { padding: .35rem .5rem; font-size: .85rem; }
  .card-body-flex {
    display: flex;
    flex-direction: column;
    min-height: 220px;
  }
  .card-meta {
    font-size: .95rem;
    color: #4b5563;
  }
  .badge-cuisine {
    background: linear-gradient(90deg,#0d6efd33,#0d6efd);
    color: #043a8b;
    font-weight:600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }
  .filter-pills .badge { margin-right: .5rem; }
  .price-text {
    white-space: nowrap;
    overflow: visible;
    font-weight: 600;
    color: #198754;
  }
  .recommended-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid #dee2e6;
  }
  .restaurant-card {
    border: none;
    border-radius: 1rem;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  .restaurant-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- SEARCH / FILTER CARD -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Search (name / description)</label>
          <input type="text" name="q" class="form-control" placeholder="Type restaurant or dish..." value="{{ q|default_if_none:'' }}">
        </div>

        <div class="col-md-2">
          <label class="form-label">Cuisine</label>
          <input type="text" name="cuisine" class="form-control" placeholder="e.g. Italian" value="{{ cuisine|default_if_none:'' }}">
        </div>

        <div class="col-md-2">
          <label class="form-label">Location</label>
          <input type="text" name="location" class="form-control" placeholder="City / Area" value="{{ location|default_if_none:'' }}">
        </div>

        <div class="col-md-2">
          <label class="form-label">Max Avg Price (₹)</label>
          <input type="number" step="0.01" name="price" class="form-control" placeholder="e.g. 500" value="{{ max_price|default_if_none:'' }}">
        </div>

        <div class="col-md-2 d-grid">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-search me-1"></i> Search
          </button>
        </div>
      </form>

      <!-- Active filters as pills -->
      <div class="mt-3 filter-pills">
        {% if q %}<span class="badge bg-light border">Keyword: {{ q }}</span>{% endif %}
        {% if cuisine %}<span class="badge bg-light border">Cuisine: {{ cuisine }}</span>{% endif %}
        {% if location %}<span class="badge bg-light border">Location: {{ location }}</span>{% endif %}
        {% if max_price %}<span class="badge bg-light border">Max Price: ₹{{ max_price }}</span>{% endif %}
      </div>
    </div>
  </div>

  <!-- RECOMMENDED -->
  {% if recommended %}
  <div class="mb-3 reco">
    <h5 class="mb-3">Recommended for you</h5>
    <div class="row gy-3">
      {% for r in recommended %}
      <div class="col-md-3">
        <div class="card h-100 shadow-sm card-hover">
          {% if r.photo %}
            <img class="restaurant-img" src="{{ r.photo.url }}" alt="{{ r.name }}">
          {% else %}
            <img class="restaurant-img" src="https://via.placeholder.com/800x450?text=Restaurant" alt="{{ r.name }}">
          {% endif %}
          <div class="card-body d-flex flex-column">
            <div>
              <h5 class="mb-1">{{ r.name }}</h5>
              {% if r.location %}
                <div class="card-meta mb-1"><i class="bi bi-geo-alt-fill"></i> {{ r.location }}</div>
              {% endif %}
              <p class="small text-muted mb-2">{{ r.description|default:"" |truncatechars:80 }}</p>
            </div>

            <div class="mt-auto">
              <div class="d-flex justify-content-between align-items-center mb-2">
                {% if r.cuisine %}<span class="badge badge-cuisine">{{ r.cuisine }}</span>{% endif %}
                <div class="text-end">
                  <div class="small card-meta">Avg Price</div>
                  <div class="price-text">₹{{ r.avg_price|default:"—" }}</div>
                </div>
              </div>
              
              <!-- Rating for recommended -->
              {% if r.avg_rating %}
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <div class="text-warning me-1">
                      {% for i in "12345" %}
                        {% if forloop.counter <= r.avg_rating %}★{% else %}☆{% endif %}
                      {% endfor %}
                    </div>
                    <span class="fw-semibold small">{{ r.avg_rating|floatformat:1 }}</span>
                  </div>
                  <small class="text-muted">({{ r.review_count }})</small>
                </div>
              {% else %}
                <div class="text-muted small">No reviews yet</div>
              {% endif %}
            </div>

            <a href="{% url 'menu' r.id %}" class="btn btn-outline-success mt-3 w-100">View Menu</a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- ALL RESTAURANTS -->
  <h5 class="mb-3">All Restaurants</h5>
  <div class="row gy-4">
    {% for restaurant in restaurants %}
    <div class="col-md-4">
      <div class="card h-100 shadow-sm card-hover">
        <div class="img-wrap">
          {% if restaurant.photo %}
            <img class="restaurant-img" src="{{ restaurant.photo.url }}" alt="{{ restaurant.name }}">
          {% else %}
            <img class="restaurant-img" src="https://via.placeholder.com/800x450?text=Restaurant" alt="{{ restaurant.name }}">
          {% endif %}
          <div class="overlay"><div class="overlay-text">{{ restaurant.description|default:"No description available."|truncatechars:120 }}</div></div>
        </div>
        <div class="card-body card-body-flex">
          <div>
            <h5 class="mb-1">{{ restaurant.name }}</h5>

            {% if restaurant.location %}
              <div class="card-meta mb-1"><i class="bi bi-geo-alt-fill"></i> {{ restaurant.location }}</div>
            {% elif restaurant.description %}
              <div class="card-meta mb-1">{{ restaurant.description|truncatechars:80 }}</div>
            {% endif %}

            <div class="row gx-2 mt-2">
              <div class="col-6">
                <div class="small text-muted">Cuisine</div>
                <div class="fw-semibold">{{ restaurant.cuisine|default:"—" }}</div>
              </div>
              <div class="col-6 text-end">
                <div class="small text-muted">Avg Price</div>
                <div class="price-text">₹{{ restaurant.avg_price|default:"—" }}</div>
              </div>
            </div>
            
            <!-- Rating Display -->
            <div class="mt-2">
              {% if restaurant.avg_rating %}
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <div class="text-warning me-1">
                      {% for i in "12345" %}
                        {% if forloop.counter <= restaurant.avg_rating %}★{% else %}☆{% endif %}
                      {% endfor %}
                    </div>
                    <span class="fw-semibold">{{ restaurant.avg_rating|floatformat:1 }}</span>
                  </div>
                  <small class="text-muted">({{ restaurant.review_count }} review{{ restaurant.review_count|pluralize }})</small>
                </div>
              {% else %}
                <div class="text-muted small">No reviews yet</div>
              {% endif %}
            </div>
          </div>

          <div class="mt-auto">
            <a href="{% url 'menu' restaurant.id %}" class="btn btn-primary w-100 mt-3">View Menu</a>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12 text-center text-muted">No restaurants match your filters.</div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  {% if restaurants.paginator %}
    <div class="mt-4 d-flex justify-content-center">
      <nav>
        <ul class="pagination">
          {% if restaurants.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ restaurants.previous_page_number }}">Previous</a></li>
          {% endif %}
            {% for num in restaurants.paginator.page_range %}
              {% if restaurants.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% else %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}
          {% if restaurants.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ restaurants.next_page_number }}">Next</a></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  {% endif %}
</div>
{% endblock %}
